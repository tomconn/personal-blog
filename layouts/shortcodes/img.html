$html
{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" | default $src -}}
{{- $class := .Get "class" -}}
{{- $loading := .Get "loading" | default "lazy" -}}
{{- $image := .Page.Resources.GetMatch $src -}}
{{- if not $image -}}
{{- warnf "Image shortcode: Resource '%s' not found in page '%s'." $src .Page.Path -}}
<p style="color: red;">ERROR: Image '{{ $src }}' not found!</p>
{{- return -}}
{{- end -}}
{{- $defaultWidths := (slice 400 800 1200) -}}
{{- $widthsToUse := $defaultWidths -}}
{{- if .IsNamedParams -}}
{{- with .Get "widths" -}}
{{- $rawWidthsParam := . -}}
{{- $parsedWidths := slice -}}
{{- range $wStrRaw := $rawWidthsParam | split "," -}}
{{- $wStrProcessed := trim $wStrRaw " \n\t\r" -}}
{{- if and $wStrProcessed (ne $wStrProcessed ",") -}}
{{- $wInt := 0 -}}
{{- $validInt := true -}}
{{- with $wStrProcessed | int -}}
{{- $wInt = . -}}
{{- else -}}
{{- $validInt = false -}}
{{- warnf "Image shortcode: Could not parse '%s' from widths string '%s' to an integer in page '%s'." $wStrProcessed $rawWidthsParam $.Page.Path -}}
{{- end -}}
{{- if and $validInt (gt $wInt 0) -}}
{{- $parsedWidths = $parsedWidths | append $wInt -}}
{{- end -}}
{{- end -}}
{{- end -}}
{{- if gt (len $parsedWidths) 0 -}}
{{- $widthsToUse = $parsedWidths | sort -}}
{{- else -}}
{{- warnf "Image shortcode: No valid widths parsed from '%s' in page '%s'. Using defaults." $rawWidthsParam $.Page.Path -}}
{{- end -}}
{{- end -}}
{{- end -}}
{{- $originalFormat := path.Ext $image.Name | strings.TrimPrefix "." -}}
{{- $webpFormat := "webp" -}}
{{- $originalImageWidth := $image.Width -}}
{{- define "generateResizeOptions" -}}
{{- $targetWidth := .targetWidth -}}
{{- $currentImageWidth := .currentImageWidth -}}
{{- $format := .format -}}
{{- $quality := .quality -}}
{{- $options := "" -}}
{{- if gt $targetWidth $currentImageWidth -}}
{{- $options = printf "%dx %s q%d" $currentImageWidth $format $quality -}}
{{- else -}}
{{- $options = printf "%dx %s q%d" $targetWidth $format $quality -}}
{{- end -}}
{{- return $options -}}
{{- end -}}
{{- $largestWidthForFallback := index (last 1 $widthsToUse) 0 -}}
{{- $fallbackImageOptionsArgs := dict "targetWidth" $largestWidthForFallback "currentImageWidth" $originalImageWidth "format" $webpFormat "quality" 75 -}}
{{- $fallbackImageOptions := partial "generateResizeOptions" $fallbackImageOptionsArgs -}}
{{- $fallbackImage := $image.Resize $fallbackImageOptions -}}
{{- if eq $originalFormat "svg" -}}{{- $fallbackImage = $image -}}{{- end -}}
{{- $contentMaxWidth := 800 -}}
{{- $sizesAttr := printf "(max-width: %dpx) 100vw, %dpx" $contentMaxWidth $contentMaxWidth -}}
<picture>
{{- if ne $originalFormat "svg" -}}
{{- $srcsetsWebP := slice -}}
{{- range $widthsToUse -}}
{{- $webpArgs := dict "targetWidth" . "currentImageWidth" $originalImageWidth "format" $webpFormat "quality" 75 -}}
{{- $webpOptions := partial "generateResizeOptions" $webpArgs -}}
{{- $resized := $image.Resize $webpOptions -}}
{{- $srcsetsWebP = $srcsetsWebP | append (printf "%s %dw" $resized.RelPermalink .) -}}
{{- end -}}
<source type="image/webp" srcset="{{ delimit $srcsetsWebP ", " }}" sizes="{{ $sizesAttr }}">
{{- end -}}
{{- if and (ne $originalFormat $webpFormat) (ne $originalFormat "svg") -}}
    {{- $srcsetsOriginal := slice -}}
    {{- range $widthsToUse -}}
        {{- $originalArgs := dict "targetWidth" . "currentImageWidth" $originalImageWidth "format" $originalFormat "quality" 80 -}}
        {{- $originalResizeOptions := "" -}}
        {{- if gt . $originalImageWidth -}}
            {{- $originalResizeOptions = printf "%dx q%d" $originalImageWidth 80 -}}
        {{- else -}}
            {{- $originalResizeOptions = printf "%dx q%d" . 80 -}}
        {{- end -}}
        {{- $resized := $image.Resize $originalResizeOptions -}}
        {{- $srcsetsOriginal = $srcsetsOriginal | append (printf "%s %dw" $resized.RelPermalink .) -}}
    {{- end -}}
    <source type="image/{{ $originalFormat }}" srcset="{{ delimit $srcsetsOriginal ", " }}" sizes="{{ $sizesAttr }}">
{{- end -}}

<img
    src="{{ $fallbackImage.RelPermalink }}"
    alt="{{ $alt }}"
    {{- with $class }} class="{{ . }}"{{ end -}}
    width="{{ $fallbackImage.Width }}"
    height="{{ $fallbackImage.Height }}"
    loading="{{ $loading }}"
    sizes="{{ $sizesAttr }}"> {{/* sizes also on img for browsers not supporting picture */}}
</picture>