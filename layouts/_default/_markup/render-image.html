$html
{{-/*
layouts/_default/_markup/render-image.html
(Full code from previous correct answer - focusing on attribute access here)
*/-}}
{{- $src := .Destination | safeURL -}}
{{- $alt := .Text | safeHTMLAttr -}}
{{- $title := .Title | safeHTMLAttr -}}
{{-/*
Accessing attributes: .Attributes is a map.
Keys are lowercased.
*/-}}
{{- $class := "" -}}
{{- if .Attributes -}}{{- $class = .Attributes.class -}}{{- end -}}
{{- $loading := "lazy" -}}
{{- if .Attributes -}}{{- $loading = .Attributes.loading | default "lazy" -}}{{- end -}}
{{- $userWidths := "" -}}
{{- if .Attributes -}}{{- $userWidths = .Attributes.widths -}}{{- end -}}
{{- $image := "" -}}
{{- $isProcessable := false -}}
{{- if strings.HasPrefix $src "http" -}}
{{-/* External image */-}}
{{- else if strings.HasPrefix $src "/" -}}
{{- $assetPath := strings.TrimPrefix "/" $src -}}
{{- with resources.GetMatch $assetPath -}}
{{- $image = . -}}
{{- $isProcessable = true -}}
{{- end -}}
{{- else -}}
{{- with .Page.Resources.GetMatch $src -}}
{{- $image = . -}}
{{- $isProcessable = true -}}
{{- else -}}
{{- warnf "Image with relative path '%s' not found in Page Resources for page '%s'." $src .Page.Path -}}
{{- end -}}
{{- end -}}
{{- if $isProcessable -}}
{{- $defaultWidths := (slice 400 600 800 1000 1200) -}}
{{- $widthsToUse := $defaultWidths -}}
{{- if $userWidths -}}
{{-/* Try to parse userWidths: split by comma, then convert to int slice */-}}
{{- $parsedWidths := slice -}}
{{- range $wStr := $userWidths | split "," -}}
{{- $wInt := $wStr | int -}}
{{- if gt $wInt 0 -}}
{{- $parsedWidths = $parsedWidths | append $wInt -}}
{{- end -}}
{{- end -}}
{{- if gt (len $parsedWidths) 0 -}}
{{- $widthsToUse = $parsedWidths | sort -}}
{{- end -}}
{{- end -}}
{{- $originalFormat := path.Ext $image.Name | strings.TrimPrefix "." -}}
{{- $webpFormat := "webp" -}}
{{- $largestWidth := index (last 1 $widthsToUse) 0 -}}
{{- $fallbackImage := $image.Resize (printf "%dx%s q75" $largestWidth $webpFormat) -}}
{{- if eq $originalFormat "svg" -}}{{- $fallbackImage = $image -}}{{- end -}}
<picture>
{{- if ne $originalFormat "svg" -}}
{{- $srcsetsWebP := slice -}}
{{- range $widthsToUse -}}
{{- $resized := $image.Resize (printf "%dx%s q75" . $webpFormat) -}}
{{- $srcsetsWebP = $srcsetsWebP | append (printf "%s %dw" $resized.RelPermalink .) -}}
{{- end -}}
<source type="image/webp" srcset="{{ delimit $srcsetsWebP ", " }}">
{{- end -}}
{{- if and (ne $originalFormat $webpFormat) (ne $originalFormat "svg") -}}
{{- $srcsetsOriginal := slice -}}
{{- range $widthsToUse -}}
{{- $resized := $image.Resize (printf "%dx q80" .) -}}
{{- $srcsetsOriginal = $srcsetsOriginal | append (printf "%s %dw" $resized.RelPermalink .) -}}
{{- end -}}
<source type="image/{{ $originalFormat }}" srcset="{{ delimit $srcsetsOriginal ", " }}">
{{- end -}}
<img
src="{{ $fallbackImage.RelPermalink }}"
alt="{{ $alt }}"
{{- with $title }} title="{{ . }}"{{ end -}}
{{- with $class }} class="{{ . }}"{{ end -}}
width="{{ $fallbackImage.Width }}"
height="{{ $fallbackImage.Height }}"
loading="{{ $loading }}">
</picture>
{{- else -}}
<img
src="{{ $src }}"
alt="{{ $alt }}"
{{- with $title }} title="{{ . }}"{{ end -}}
{{- with $class }} class="{{ . }}"{{ end -}}
loading="{{ $loading }}"
style="max-width: 100%; height: auto;">
{{- end -}}